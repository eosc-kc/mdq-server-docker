<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    default-lazy-init="true"
    xmlns:c="http://www.springframework.org/schema/c"
    xmlns:p="http://www.springframework.org/schema/p"
    xmlns:util="http://www.springframework.org/schema/util"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd">

    <!--
        Import InCommon beans.
    -->
    <import resource="file:${mdq.home}/us_incommon/beans.xml"/>

    <!--
        Import eduGAIN beans.
    -->
    <import resource="classpath:int_edugain/beans.xml"/>

    <!--
        removeInCommonEntities

        Filter out entities which declare themselves as registered
        by our federation.  We don't want those coming back in
        from another registrar or metadata exchange as they may be
        old versions of entities we have deregistered, or spoofed.
    -->
    <bean id="removeInCommonEntities" parent="EntityRegistrationAuthorityFilterStage"
        p:id="removeInCommonEntities">
        <property name="designatedRegistrationAuthorities">
            <list>
                <ref bean="us_incommon_registrar"/>
            </list>
        </property>
        <property name="requiringRegistrationInformation" value="true"/>
        <property name="whitelistingRegistrationAuthorities" value="false"/>
    </bean>

    <!--
        edugain_importPipeline
    -->
    <bean id="edugain_importPipeline" parent="SimplePipeline"
        p:id="edugain_importPipeline">
        <property name="stages">
            <list>
                <ref bean="int_edugain_productionEntities"/>

                <!-- Remove entities from our own federation. -->
                <ref bean="removeInCommonEntities"/>

                <!-- Remove all but the entities we want to import. -->
                <bean parent="XPathFilteringStage"
                    p:XPathExpression="not(md:IDPSSODescriptor)"/>

                <!-- Filter the entity attributes imported from eduGAIN. -->
                <bean parent="EntityAttributeFilteringStage" p:id="entityAttributes">
                   <property name="rules">
                       <list>
                           <!-- Permit REFEDS R&S category membership -->
                           <bean parent="EntityCategoryMatcher"
                                c:category="http://refeds.org/category/research-and-scholarship"/>

                           <!-- Permit REFEDS R&S category support -->
                           <bean parent="EntityCategorySupportMatcher"
                               c:category="http://refeds.org/category/research-and-scholarship"/>

                       </list>
                   </property>
                </bean>

                <ref bean="standardImportActions"/>

                <!--
                    Silently remove entities which are marked as
                    having errors.
                -->
                <ref bean="errorRemover"/>
            </list>
        </property>
    </bean>

    <!--
        Pipeline used to acquire metadata for service.

        Input: empty collection.

        Output: collection of individual entity metadata items.

        The main line of this pipeline imports and processes entities from InCommon.
        Entities from eduGAIN are merged in from a separate pipeline.
    -->
    <bean id="source.SAML" parent="SimplePipeline">
        <property name="stages">
            <list>
                <!-- Start with the InCommon production aggregate. -->
                <ref bean="us_incommon_productionEntities"/>
                <ref bean="populateItemIds"/>

                <!-- Retain only IdP entities. -->
                <bean parent="XPathFilteringStage"
                    p:XPathExpression="not(md:IDPSSODescriptor)"/>

                <!-- Include a default registrationAuthority for each entity. -->
                <ref bean="us_incommon_default_regauth"/>

                <!-- Merge in entities from eduGAIN. -->
                <bean id="mergeProductionMDXEntities" parent="PipelineMergeStage.deduplicate"
                    p:id="mergeProductionMDXortedEntities">
                    <property name="mergedPipelines">
                        <ref bean="edugain_importPipeline"/>
                    </property>
                </bean>

                <!-- Add SHA1-transformed IDs for all entities. -->
                <bean class="net.shibboleth.metadata.pipeline.ItemIdTransformStage">
                    <property name="idTransformers">
                        <bean class="net.shibboleth.metadata.pipeline.MDQuerySHA1ItemIdTransformer"/>
                    </property>
                </bean>

                <!-- Additional processing for IdPs only. -->
                <bean parent="stage_parent" class="net.shibboleth.metadata.pipeline.SplitMergeStage">
                    <!-- Select IdP entities. -->
                    <property name="selectionStrategy">
                        <bean class="net.shibboleth.metadata.dom.XPathItemSelectionStrategy">
                            <constructor-arg value="md:IDPSSODescriptor"/>
                            <constructor-arg ref="commonNamespaces"/>
                        </bean>
                    </property>
                    <property name="selectedItemPipeline">
                        <bean parent="SimplePipeline">
                            <property name="stages">
                                <list>

                                    <!-- Tag all IdPs as "collection:idps". -->
                                    <bean class="net.shibboleth.metadata.pipeline.ItemMetadataAddingStage">
                                        <property name="additionalItemMetadata">
                                            <bean class="net.shibboleth.metadata.ItemTag" c:itemTag="collection:idps"/>
                                        </property>
                                    </bean>

                                    <!-- Tag IdPs having InCommon R&S support entity attribute as "collection:inc-r-and-s-idps". -->
                                    <bean parent="stage_parent" class="net.shibboleth.metadata.pipeline.SplitMergeStage">
                                        <property name="selectionStrategy">
                                            <bean class="net.shibboleth.metadata.dom.XPathItemSelectionStrategy">
                                                <constructor-arg value="md:Extensions/mdattr:EntityAttributes
                                                    /saml:Attribute[@Name='http://macedir.org/entity-category-support']
                                                        [@NameFormat='urn:oasis:names:tc:SAML:2.0:attrname-format:uri']
                                                    /saml:AttributeValue[.='http://id.incommon.org/category/research-and-scholarship']"/>
                                                <constructor-arg ref="commonNamespaces"/>
                                            </bean>
                                        </property>
                                        <property name="selectedItemPipeline">
                                            <bean parent="SimplePipeline">
                                                <property name="stages">
                                                    <bean class="net.shibboleth.metadata.pipeline.ItemMetadataAddingStage">
                                                        <property name="additionalItemMetadata">
                                                            <bean class="net.shibboleth.metadata.ItemTag"
                                                                c:itemTag="collection:inc-r-and-s-idps"/>
                                                        </property>
                                                    </bean>
                                                </property>
                                            </bean>
                                        </property>
                                    </bean>

                                    <!-- Tag IdPs having REFEDS R&S support entity attribute as "collection:refeds-r-and-s-idps". -->
                                    <bean parent="stage_parent" class="net.shibboleth.metadata.pipeline.SplitMergeStage">
                                        <property name="selectionStrategy">
                                            <bean class="net.shibboleth.metadata.dom.XPathItemSelectionStrategy">
                                                <constructor-arg value="md:Extensions/mdattr:EntityAttributes
                                                    /saml:Attribute[@Name='http://macedir.org/entity-category-support']
                                                        [@NameFormat='urn:oasis:names:tc:SAML:2.0:attrname-format:uri']
                                                    /saml:AttributeValue[.='http://refeds.org/category/research-and-scholarship']"/>
                                                <constructor-arg ref="commonNamespaces"/>
                                            </bean>
                                        </property>
                                        <property name="selectedItemPipeline">
                                            <bean parent="SimplePipeline">
                                                <property name="stages">
                                                    <bean class="net.shibboleth.metadata.pipeline.ItemMetadataAddingStage">
                                                        <property name="additionalItemMetadata">
                                                            <list>
                                                                <bean class="net.shibboleth.metadata.ItemTag"
                                                                    c:itemTag="collection:refeds-r-and-s-idps"/>
                                                            </list>
                                                        </property>
                                                    </bean>
                                                </property>
                                            </bean>
                                        </property>
                                    </bean>

                                </list>
                            </property>
                        </bean>
                    </property>
                </bean>

            </list>
        </property>
    </bean>

</beans>
